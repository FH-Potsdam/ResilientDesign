// Copyright (c) 2013 Adobe Systems Incorporated. All rights reserved.
// 
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// 
// http://www.apache.org/licenses/LICENSE-2.0
// 
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
Snap.plugin(function(e,t,n,r){var i=t.prototype,s=n.prototype,o=/^\s*url\((.+)\)/,u=String,a=e._.$;e.filter={};s.filter=function(n){var r=this;r.type!="svg"&&(r=r.paper);var i=e.parse(u(n)),s=e._.id(),o=r.node.offsetWidth,f=r.node.offsetHeight,l=a("filter");a(l,{id:s,filterUnits:"userSpaceOnUse"});l.appendChild(i.node);r.defs.appendChild(l);return new t(l)};eve.on("snap.util.getattr.filter",function(){eve.stop();var t=a(this.node,"filter");if(t){var n=u(t).match(o);return n&&e.select(n[1])}});eve.on("snap.util.attr.filter",function(n){if(n instanceof t&&n.type=="filter"){eve.stop();var r=n.node.id;if(!r){a(n.node,{id:n.id});r=n.id}a(this.node,{filter:e.url(r)})}if(!n||n=="none"){eve.stop();this.node.removeAttribute("filter")}});e.filter.blur=function(t,n){t==null&&(t=2);var r=n==null?t:[t,n];return e.format('<feGaussianBlur stdDeviation="{def}"/>',{def:r})};e.filter.blur.toString=function(){return this()};e.filter.shadow=function(t,n,r,i,s){if(typeof r=="string"){i=r;s=i;r=4}if(typeof i!="string"){s=i;i="#000"}i=i||"#000";r==null&&(r=4);s==null&&(s=1);if(t==null){t=0;n=2}n==null&&(n=t);i=e.color(i);return e.format('<feGaussianBlur in="SourceAlpha" stdDeviation="{blur}"/><feOffset dx="{dx}" dy="{dy}" result="offsetblur"/><feFlood flood-color="{color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="{opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>',{color:i,dx:t,dy:n,blur:r,opacity:s})};e.filter.shadow.toString=function(){return this()};e.filter.grayscale=function(t){t==null&&(t=1);return e.format('<feColorMatrix type="matrix" values="{a} {b} {c} 0 0 {d} {e} {f} 0 0 {g} {b} {h} 0 0 0 0 0 1 0"/>',{a:.2126+.7874*(1-t),b:.7152-.7152*(1-t),c:.0722-.0722*(1-t),d:.2126-.2126*(1-t),e:.7152+.2848*(1-t),f:.0722-.0722*(1-t),g:.2126-.2126*(1-t),h:.0722+.9278*(1-t)})};e.filter.grayscale.toString=function(){return this()};e.filter.sepia=function(t){t==null&&(t=1);return e.format('<feColorMatrix type="matrix" values="{a} {b} {c} 0 0 {d} {e} {f} 0 0 {g} {h} {i} 0 0 0 0 0 1 0"/>',{a:.393+.607*(1-t),b:.769-.769*(1-t),c:.189-.189*(1-t),d:.349-.349*(1-t),e:.686+.314*(1-t),f:.168-.168*(1-t),g:.272-.272*(1-t),h:.534-.534*(1-t),i:.131+.869*(1-t)})};e.filter.sepia.toString=function(){return this()};e.filter.saturate=function(t){t==null&&(t=1);return e.format('<feColorMatrix type="saturate" values="{amount}"/>',{amount:1-t})};e.filter.saturate.toString=function(){return this()};e.filter.hueRotate=function(t){t=t||0;return e.format('<feColorMatrix type="hueRotate" values="{angle}"/>',{angle:t})};e.filter.hueRotate.toString=function(){return this()};e.filter.invert=function(t){t==null&&(t=1);return e.format('<feComponentTransfer><feFuncR type="table" tableValues="{amount} {amount2}"/><feFuncG type="table" tableValues="{amount} {amount2}"/><feFuncB type="table" tableValues="{amount} {amount2}"/></feComponentTransfer>',{amount:t,amount2:1-t})};e.filter.invert.toString=function(){return this()};e.filter.brightness=function(t){t==null&&(t=1);return e.format('<feComponentTransfer><feFuncR type="linear" slope="{amount}"/><feFuncG type="linear" slope="{amount}"/><feFuncB type="linear" slope="{amount}"/></feComponentTransfer>',{amount:t})};e.filter.brightness.toString=function(){return this()};e.filter.contrast=function(t){t==null&&(t=1);return e.format('<feComponentTransfer><feFuncR type="linear" slope="{amount}" intercept="{amount2}"/><feFuncG type="linear" slope="{amount}" intercept="{amount2}"/><feFuncB type="linear" slope="{amount}" intercept="{amount2}"/></feComponentTransfer>',{amount:t,amount2:.5-t/2})};e.filter.contrast.toString=function(){return this()}});