// Copyright (c) 2013 Adobe Systems Incorporated. All rights reserved.
// 
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// 
// http://www.apache.org/licenses/LICENSE-2.0
// 
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
Snap.plugin(function(e,t,n,r){var i=t.prototype,s="hasOwnProperty",o="createTouch"in r.doc,u=["click","dblclick","mousedown","mousemove","mouseout","mouseover","mouseup","touchstart","touchmove","touchend","touchcancel"],a={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},f=function(e,t){var n=e=="y"?"scrollTop":"scrollLeft",i=t&&t.node?t.node.ownerDocument:r.doc;return i[n in i.documentElement?"documentElement":"body"][n]},l=function(){this.returnValue=!1},c=function(){return this.originalEvent.preventDefault()},h=function(){this.cancelBubble=!0},p=function(){return this.originalEvent.stopPropagation()},d=function(e,t,n,r){var i=o&&a[t]?a[t]:t,u=function(i){var u=f("y",r),l=f("x",r);if(o&&a[s](t))for(var h=0,d=i.targetTouches&&i.targetTouches.length;h<d;h++)if(i.targetTouches[h].target==e||e.contains(i.targetTouches[h].target)){var v=i;i=i.targetTouches[h];i.originalEvent=v;i.preventDefault=c;i.stopPropagation=p;break}var m=i.clientX+l,g=i.clientY+u;return n.call(r,i,m,g)};t!==i&&e.addEventListener(t,u,!1);e.addEventListener(i,u,!1);return function(){t!==i&&e.removeEventListener(t,u,!1);e.removeEventListener(i,u,!1);return!0}},v=[],m=function(e){var t=e.clientX,n=e.clientY,r=f("y"),i=f("x"),s,u=v.length;while(u--){s=v[u];if(o){var a=e.touches&&e.touches.length,l;while(a--){l=e.touches[a];if(l.identifier==s.el._drag.id||s.el.node.contains(l.target)){t=l.clientX;n=l.clientY;(e.originalEvent?e.originalEvent:e).preventDefault();break}}}else e.preventDefault();var c=s.el.node,h,p=c.nextSibling,d=c.parentNode,m=c.style.display;t+=i;n+=r;eve("snap.drag.move."+s.el.id,s.move_scope||s.el,t-s.el._drag.x,n-s.el._drag.y,t,n,e)}},g=function(t){e.unmousemove(m).unmouseup(g);var n=v.length,r;while(n--){r=v[n];r.el._drag={};eve("snap.drag.end."+r.el.id,r.end_scope||r.start_scope||r.move_scope||r.el,t);eve.off("snap.drag.*."+r.el.id)}v=[]};for(var y=u.length;y--;)(function(t){e[t]=i[t]=function(n,r){if(e.is(n,"function")){this.events=this.events||[];this.events.push({name:t,f:n,unbind:d(this.node||document,t,n,r||this)})}else for(var i=0,s=this.events.length;i<s;i++)if(this.events[i].name==t)try{this.events[i].f.call(this)}catch(o){}return this};e["un"+t]=i["un"+t]=function(e){var n=this.events||[],r=n.length;while(r--)if(n[r].name==t&&(n[r].f==e||!e)){n[r].unbind();n.splice(r,1);!n.length&&delete this.events;return this}return this}})(u[y]);i.hover=function(e,t,n,r){return this.mouseover(e,n).mouseout(t,r||n)};i.unhover=function(e,t){return this.unmouseover(e).unmouseout(t)};var b=[];i.drag=function(t,n,r,i,s,o){function f(a,f,l){(a.originalEvent||a).preventDefault();u._drag.x=f;u._drag.y=l;u._drag.id=a.identifier;!v.length&&e.mousemove(m).mouseup(g);v.push({el:u,move_scope:i,start_scope:s,end_scope:o});n&&eve.on("snap.drag.start."+u.id,n);t&&eve.on("snap.drag.move."+u.id,t);r&&eve.on("snap.drag.end."+u.id,r);eve("snap.drag.start."+u.id,s||i||u,f,l,a)}function l(e,t,n){eve("snap.draginit."+u.id,u,e,t,n)}var u=this;if(!arguments.length){var a;return u.drag(function(e,t){this.attr({transform:a+(a?"T":"t")+[e,t]})},function(){a=this.transform().local})}eve.on("snap.draginit."+u.id,f);u._drag={};b.push({el:u,start:f,init:l});u.mousedown(l);return u};i.undrag=function(){var t=b.length;while(t--)if(b[t].el==this){this.unmousedown(b[t].init);b.splice(t,1);eve.unbind("snap.drag.*."+this.id);eve.unbind("snap.draginit."+this.id)}!b.length&&e.unmousemove(m).unmouseup(g);return this}});