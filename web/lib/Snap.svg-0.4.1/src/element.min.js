// Copyright (c) 2013 Adobe Systems Incorporated. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
Snap.plugin(function(e,t,n,r,i){function v(t,n){if(n==null){var r=!0;t.type=="linearGradient"||t.type=="radialGradient"?n=t.node.getAttribute("gradientTransform"):t.type=="pattern"?n=t.node.getAttribute("patternTransform"):n=t.node.getAttribute("transform");if(!n)return new e.Matrix;n=e._.svgTransform2string(n)}else{e._.rgTransform.test(n)?n=u(n).replace(/\.{3}|\u2026/g,t._.transform||""):n=e._.svgTransform2string(n);o(n,"array")&&(n=e.path?e.path.toString.call(n):u(n));t._.transform=n}var i=e._.transform2matrix(n,t.getBBox(1));if(r)return i;t.matrix=i}function m(e){function o(e,t){var n=f(e.node,t);n=n&&n.match(r);n=n&&n[2];if(!n||n.charAt()!="#")return;n=n.substring(1);n&&(s[n]=(s[n]||[]).concat(function(n){var r={};r[t]=URL(n);f(e.node,r)}))}function u(e){var t=f(e.node,"xlink:href");if(!t||t.charAt()!="#")return;t=t.substring(1);t&&(s[t]=(s[t]||[]).concat(function(t){e.attr("xlink:href","#"+t)}))}var t=e.selectAll("*"),n,r=/^\s*url\(("|'|)(.*)\1\)\s*$/,i=[],s={};for(var a=0,l=t.length;a<l;a++){n=t[a];o(n,"fill");o(n,"stroke");o(n,"filter");o(n,"mask");o(n,"clip-path");u(n);var c=f(n.node,"id");if(c){f(n.node,{id:n.id});i.push({old:c,id:n.id})}}for(a=0,l=i.length;a<l;a++){var h=s[i[a].old];if(h)for(var p=0,d=h.length;p<d;p++)h[p](i[a].id)}}function g(e,t,n){return function(r){var i=r.slice(e,t);i.length==1&&(i=i[0]);return n?n(i):i}}function w(e){return function(){var t=e?"<"+this.type:"",n=this.node.attributes,r=this.node.childNodes;if(e)for(var i=0,s=n.length;i<s;i++)t+=" "+n[i].name+'="'+n[i].value.replace(/"/g,'\\"')+'"';if(r.length){e&&(t+=">");for(i=0,s=r.length;i<s;i++)r[i].nodeType==3?t+=r[i].nodeValue:r[i].nodeType==1&&(t+=p(r[i]).toString());e&&(t+="</"+this.type+">")}else e&&(t+="/>");return t}}var s=t.prototype,o=e.is,u=String,a=e._unit2px,f=e._.$,l=e._.make,c=e._.getSomeDefs,h="hasOwnProperty",p=e._.wrap;s.getBBox=function(t){if(!e.Matrix||!e.path)return this.node.getBBox();var n=this,r=new e.Matrix;if(n.removed)return e._.box();while(n.type=="use"){t||(r=r.add(n.transform().localMatrix.translate(n.attr("x")||0,n.attr("y")||0)));if(n.original)n=n.original;else{var i=n.attr("xlink:href");n=n.original=n.node.ownerDocument.getElementById(i.substring(i.indexOf("#")+1))}}var s=n._,o=e.path.get[n.type]||e.path.get.deflt;try{if(t){s.bboxwt=o?e.path.getBBox(n.realPath=o(n)):e._.box(n.node.getBBox());return e._.box(s.bboxwt)}n.realPath=o(n);n.matrix=n.transform().localMatrix;s.bbox=e.path.getBBox(e.path.map(n.realPath,r.add(n.matrix)));return e._.box(s.bbox)}catch(u){return e._.box()}};var d=function(){return this.string};s.transform=function(t){var n=this._;if(t==null){var r=this,i=new e.Matrix(this.node.getCTM()),s=v(this),o=[s],a=new e.Matrix,l,c=s.toTransformString(),h=u(s)==u(this.matrix)?u(n.transform):c;while(r.type!="svg"&&(r=r.parent()))o.push(v(r));l=o.length;while(l--)a.add(o[l]);return{string:h,globalMatrix:i,totalMatrix:a,localMatrix:s,diffMatrix:i.clone().add(s.invert()),global:i.toTransformString(),total:a.toTransformString(),local:c,toString:d}}if(t instanceof e.Matrix){this.matrix=t;this._.transform=t.toTransformString()}else v(this,t);this.node&&(this.type=="linearGradient"||this.type=="radialGradient"?f(this.node,{gradientTransform:this.matrix}):this.type=="pattern"?f(this.node,{patternTransform:this.matrix}):f(this.node,{transform:this.matrix}));return this};s.parent=function(){return p(this.node.parentNode)};s.append=s.add=function(e){if(e){if(e.type=="set"){var t=this;e.forEach(function(e){t.add(e)});return this}e=p(e);this.node.appendChild(e.node);e.paper=this.paper}return this};s.appendTo=function(e){if(e){e=p(e);e.append(this)}return this};s.prepend=function(e){if(e){if(e.type=="set"){var t=this,n;e.forEach(function(e){n?n.after(e):t.prepend(e);n=e});return this}e=p(e);var r=e.parent();this.node.insertBefore(e.node,this.node.firstChild);this.add&&this.add();e.paper=this.paper;this.parent()&&this.parent().add();r&&r.add()}return this};s.prependTo=function(e){e=p(e);e.prepend(this);return this};s.before=function(e){if(e.type=="set"){var t=this;e.forEach(function(e){var n=e.parent();t.node.parentNode.insertBefore(e.node,t.node);n&&n.add()});this.parent().add();return this}e=p(e);var n=e.parent();this.node.parentNode.insertBefore(e.node,this.node);this.parent()&&this.parent().add();n&&n.add();e.paper=this.paper;return this};s.after=function(e){e=p(e);var t=e.parent();this.node.nextSibling?this.node.parentNode.insertBefore(e.node,this.node.nextSibling):this.node.parentNode.appendChild(e.node);this.parent()&&this.parent().add();t&&t.add();e.paper=this.paper;return this};s.insertBefore=function(e){e=p(e);var t=this.parent();e.node.parentNode.insertBefore(this.node,e.node);this.paper=e.paper;t&&t.add();e.parent()&&e.parent().add();return this};s.insertAfter=function(e){e=p(e);var t=this.parent();e.node.parentNode.insertBefore(this.node,e.node.nextSibling);this.paper=e.paper;t&&t.add();e.parent()&&e.parent().add();return this};s.remove=function(){var e=this.parent();this.node.parentNode&&this.node.parentNode.removeChild(this.node);delete this.paper;this.removed=!0;e&&e.add();return this};s.select=function(e){return p(this.node.querySelector(e))};s.selectAll=function(t){var n=this.node.querySelectorAll(t),r=(e.set||Array)();for(var i=0;i<n.length;i++)r.push(p(n[i]));return r};s.asPX=function(e,t){t==null&&(t=this.attr(e));return+a(this,e,t)};s.use=function(){var e,t=this.node.id;if(!t){t=this.id;f(this.node,{id:t})}this.type=="linearGradient"||this.type=="radialGradient"||this.type=="pattern"?e=l(this.type,this.node.parentNode):e=l("use",this.node.parentNode);f(e.node,{"xlink:href":"#"+t});e.original=this;return e};s.clone=function(){var e=p(this.node.cloneNode(!0));f(e.node,"id")&&f(e.node,{id:e.id});m(e);e.insertAfter(this);return e};s.toDefs=function(){var e=c(this);e.appendChild(this.node);return this};s.pattern=s.toPattern=function(e,t,n,r){var i=l("pattern",c(this));e==null&&(e=this.getBBox());if(o(e,"object")&&"x"in e){t=e.y;n=e.width;r=e.height;e=e.x}f(i.node,{x:e,y:t,width:n,height:r,patternUnits:"userSpaceOnUse",id:i.id,viewBox:[e,t,n,r].join(" ")});i.node.appendChild(this.node);return i};s.marker=function(e,t,n,r,i,s){var u=l("marker",c(this));e==null&&(e=this.getBBox());if(o(e,"object")&&"x"in e){t=e.y;n=e.width;r=e.height;i=e.refX||e.cx;s=e.refY||e.cy;e=e.x}f(u.node,{viewBox:[e,t,n,r].join(" "),markerWidth:n,markerHeight:r,orient:"auto",refX:i||0,refY:s||0,id:u.id});u.node.appendChild(this.node);return u};var y=function(e,t,n,r){if(typeof n=="function"&&!n.length){r=n;n=mina.linear}this.attr=e;this.dur=t;n&&(this.easing=n);r&&(this.callback=r)};e._.Animation=y;e.animation=function(e,t,n,r){return new y(e,t,n,r)};s.inAnim=function(){var e=this,t=[];for(var n in e.anims)e.anims[h](n)&&function(e){t.push({anim:new y(e._attrs,e.dur,e.easing,e._callback),mina:e,curStatus:e.status(),status:function(t){return e.status(t)},stop:function(){e.stop()}})}(e.anims[n]);return t};e.animate=function(e,t,n,r,i,s){if(typeof i=="function"&&!i.length){s=i;i=mina.linear}var o=mina.time(),u=mina(e,t,o,o+r,mina.time,n,i);s&&eve.once("mina.finish."+u.id,s);return u};s.stop=function(){var e=this.inAnim();for(var t=0,n=e.length;t<n;t++)e[t].stop();return this};s.animate=function(e,t,n,r){if(typeof n=="function"&&!n.length){r=n;n=mina.linear}if(e instanceof y){r=e.callback;n=e.easing;t=e.dur;e=e.attr}var i=[],s=[],a={},f,l,c,p,d=this;for(var v in e)if(e[h](v)){if(d.equal){p=d.equal(v,u(e[v]));f=p.from;l=p.to;c=p.f}else{f=+d.attr(v);l=+e[v]}var m=o(f,"array")?f.length:1;a[v]=g(i.length,i.length+m,c);i=i.concat(f);s=s.concat(l)}var b=mina.time(),w=mina(i,s,b,b+t,mina.time,function(e){var t={};for(var n in a)a[h](n)&&(t[n]=a[n](e));d.attr(t)},n);d.anims[w.id]=w;w._attrs=e;w._callback=r;eve("snap.animcreated."+d.id,w);eve.once("mina.finish."+w.id,function(){delete d.anims[w.id];r&&r.call(d)});eve.once("mina.stop."+w.id,function(){delete d.anims[w.id]});return d};var b={};s.data=function(t,n){var r=b[this.id]=b[this.id]||{};if(arguments.length==0){eve("snap.data.get."+this.id,this,r,null);return r}if(arguments.length==1){if(e.is(t,"object")){for(var i in t)t[h](i)&&this.data(i,t[i]);return this}eve("snap.data.get."+this.id,this,r[t],t);return r[t]}r[t]=n;eve("snap.data.set."+this.id,this,n,t);return this};s.removeData=function(e){e==null?b[this.id]={}:b[this.id]&&delete b[this.id][e];return this};s.outerSVG=s.toString=w(1);s.innerSVG=w();s.toDataURL=function(){if(window&&window.btoa){var t=this.getBBox(),n=e.format('<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="{width}" height="{height}" viewBox="{x} {y} {width} {height}">{contents}</svg>',{x:+t.x.toFixed(3),y:+t.y.toFixed(3),width:+t.width.toFixed(3),height:+t.height.toFixed(3),contents:this.outerSVG()});return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(n)))}};i.prototype.select=s.select;i.prototype.selectAll=s.selectAll});